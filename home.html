<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatGPT - Think-LIE</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f9f9f9;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: #f9f9f9;
            border-right: 1px solid #ececec;
            display: flex;
            flex-direction: column;
            padding: 8px;
        }

        .sidebar-header {
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: #000;
        }

        .logo svg {
            width: 24px;
            height: 24px;
        }

        .new-chat-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 12px 16px;
            width: 100%;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #f3f4f6;
        }

        .sidebar-section {
            flex: 1;
            overflow-y: auto;
            padding: 4px 0;
        }

        .chat-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: background 0.2s;
            margin-bottom: 2px;
        }

        .chat-item:hover {
            background: #f3f4f6;
        }

        .chat-item.active {
            background: #ececec;
        }

        .sidebar-footer {
            padding: 8px;
            border-top: 1px solid #ececec;
        }

        .user-profile {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }

        .user-profile:hover {
            background: #f3f4f6;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: linear-gradient(135deg, #10a37f 0%, #0d7a5f 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: #000;
        }

        .logout-btn {
            background: #fee;
            color: #c00;
            border: 1px solid #fcc;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 8px;
            width: 100%;
        }

        .logout-btn:hover {
            background: #fcc;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 12px 16px;
            border-bottom: 1px solid #ececec;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .model-selector {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .model-selector:hover {
            background: #f3f4f6;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .chat-messages.empty {
            align-items: center;
            justify-content: center;
        }

        .welcome-screen {
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
        }

        .welcome-title {
            font-size: 32px;
            font-weight: 400;
            color: #000;
            margin-bottom: 40px;
        }

        .message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            padding: 0 20px;
        }

        .message-avatar {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10a37f 0%, #0d7a5f 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: #10a37f;
            color: white;
        }

        .message-content {
            flex: 1;
            font-size: 16px;
            line-height: 1.6;
            color: #374151;
            padding-top: 4px;
            white-space: pre-wrap;
        }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        /* Input Area */
        .input-area {
            padding: 20px;
            border-top: 1px solid #ececec;
            background: white;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-wrapper {
            position: relative;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.05);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-wrapper:focus-within {
            border-color: #10a37f;
            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.1);
        }

        .input-main {
            display: flex;
            align-items: flex-end;
            padding: 12px 16px;
            gap: 12px;
        }

        #messageInput {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            font-family: inherit;
            resize: none;
            max-height: 200px;
            line-height: 1.5;
            color: #000;
        }

        #messageInput::placeholder {
            color: #9ca3af;
        }

        #sendButton {
            background: #ececec;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            color: #6b7280;
        }

        #sendButton:hover:not(:disabled) {
            background: #d1d5db;
        }

        #sendButton.active {
            background: #10a37f;
            color: white;
        }

        #sendButton.active:hover {
            background: #0d7a5f;
        }

        #sendButton:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        /* Animation for new messages */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message {
            animation: slideIn 0.3s ease-out;
        }

        /* Loading animation */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <svg viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707Z" fill="currentColor"/>
                    </svg>
                    <span>ChatGPT</span>
                </div>
            </div>

            <button class="new-chat-btn" onclick="newChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"></path>
                    <path d="m15 5 4 4"></path>
                </svg>
                New chat
            </button>

            <div class="sidebar-section">
                <div class="chat-item active">Ready when you are.</div>
            </div>

            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">User</div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="chat-header">
                <button class="model-selector">
                    Think-LIE AI
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
            </div>

            <div class="chat-messages empty" id="chatMessages">
                <div class="welcome-screen">
                    <h1 class="welcome-title">Ready when you are.</h1>
                </div>
            </div>

            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <div class="input-main">
                            <textarea 
                                id="messageInput" 
                                placeholder="Ask anything" 
                                rows="1"
                                onkeydown="handleKeyPress(event)"
                                oninput="autoResize(this); updateSendButton()"
                            ></textarea>
                            <button id="sendButton" onclick="sendMessage()" disabled>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="22" y1="2" x2="11" y2="13"></line>
                                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = " http://127.0.0.1:8000";
        
        let userToken = null;
        let userEmail = null;

        // Check authentication on load
        window.addEventListener('load', () => {
            userToken = localStorage.getItem('token');
            userEmail = localStorage.getItem('user_email');
            
            if (!userToken) {
                window.location.href = 'signup.html';
                return;
            }
            
            // Set user info
            if (userEmail) {
                const userName = document.getElementById('userName');
                const userAvatar = document.getElementById('userAvatar');
                userName.textContent = userEmail.split('@')[0];
                userAvatar.textContent = userEmail[0].toUpperCase();
            }
            
            // Load chat history
            loadChatHistory();
        });

        // Logout function
        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user_email');
            window.location.href = 'signup.html';
        }

        // Auto-resize textarea
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        // Update send button state
        function updateSendButton() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendButton');
            const hasText = input.value.trim().length > 0;
            
            sendBtn.disabled = !hasText;
            if (hasText) {
                sendBtn.classList.add('active');
            } else {
                sendBtn.classList.remove('active');
            }
        }

        // Handle Enter key
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Load chat history
        async function loadChatHistory() {
            try {
                const response = await fetch(`${API_URL}/chat/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const chatMessages = document.getElementById('chatMessages');
                    
                    if (data.messages && data.messages.length > 0) {
                        chatMessages.classList.remove('empty');
                        chatMessages.innerHTML = '';
                        
                        data.messages.forEach(msg => {
                            addMessageToUI(msg.role, msg.content);
                        });
                    }
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error loading chat history:', error);
            }
        }

        // Add message to UI
        function addMessageToUI(role, content) {
            const chatMessages = document.getElementById('chatMessages');
            
            if (chatMessages.classList.contains('empty')) {
                chatMessages.classList.remove('empty');
                chatMessages.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${userEmail ? userEmail[0].toUpperCase() : 'U'}</div>
                    <div class="message-content">${escapeHtml(content)}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <svg viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px;">
                            <path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707Z" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="message-content">${escapeHtml(content)}</div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message - ✅ USING YOUR AUTHORIZATION HEADER FORMAT
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message === '' || !userToken) return;

            // Add user message to UI
            addMessageToUI('user', message);

            // Clear input
            input.value = '';
            autoResize(input);
            updateSendButton();

            // Show typing indicator
            const chatMessages = document.getElementById('chatMessages');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <svg viewBox="0 0 41 41" fill="none" xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px;">
                        <path d="M37.5324 16.8707C37.9808 15.5241 38.1363 14.0974 37.9886 12.6859C37.8409 11.2744 37.3934 9.91076 36.676 8.68622C35.6126 6.83404 33.9882 5.3676 32.0373 4.4985C30.0864 3.62941 27.9098 3.40259 25.8215 3.85078C24.8796 2.7893 23.7219 1.94125 22.4257 1.36341C21.1295 0.785575 19.7249 0.491269 18.3058 0.500197C16.1708 0.495044 14.0893 1.16803 12.3614 2.42214C10.6335 3.67624 9.34853 5.44666 8.6917 7.47815C7.30085 7.76286 5.98686 8.3414 4.8377 9.17505C3.68854 10.0087 2.73073 11.0782 2.02839 12.312C0.956464 14.1591 0.498905 16.2988 0.721698 18.4228C0.944492 20.5467 1.83612 22.5449 3.268 24.1293C2.81966 25.4759 2.66413 26.9026 2.81182 28.3141C2.95951 29.7256 3.40701 31.0892 4.12437 32.3138C5.18791 34.1659 6.8123 35.6322 8.76321 36.5013C10.7141 37.3704 12.8907 37.5973 14.9789 37.1492C15.9208 38.2107 17.0786 39.0587 18.3747 39.6366C19.6709 40.2144 21.0755 40.5087 22.4946 40.4998C24.6307 40.5054 26.7133 39.8321 28.4418 38.5772C30.1704 37.3223 31.4556 35.5506 32.1119 33.5179C33.5027 33.2332 34.8167 32.6547 35.9659 31.821C37.115 30.9874 38.0728 29.9178 38.7752 28.684C39.8458 26.8371 40.3023 24.6979 40.0789 22.5748C39.8556 20.4517 38.9639 18.4544 37.5324 16.8707Z" fill="currentColor"/>
                    </svg>
                </div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // ✅ Send to backend with Authorization header (YOUR FORMAT)
            try {
                const response = await fetch(`${API_URL}/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userToken}`
                    },
                    body: JSON.stringify({ message: message })
                });

                // Remove typing indicator
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }

                if (response.ok) {
                    const data = await response.json();
                    addMessageToUI('assistant', data.reply);
                } else if (response.status === 401) {
                    alert('Session expired. Please login again.');
                    logout();
                } else {
                    const errorData = await response.json();
                    console.error('Error:', errorData);
                    addMessageToUI('assistant', 'Sorry, I encountered an error. Please try again.');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
                addMessageToUI('assistant', 'Network error. Please check your connection and try again.');
            }
        }

        // New chat function
        async function newChat() {
            if (!confirm('Are you sure you want to start a new chat? This will clear your current conversation.')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/chat/clear`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });

                if (response.ok) {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.classList.add('empty');
                    chatMessages.innerHTML = `
                        <div class="welcome-screen">
                            <h1 class="welcome-title">Ready when you are.</h1>
                        </div>
                    `;
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error clearing chat:', error);
                alert('Failed to clear chat. Please try again.');
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Focus input on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('messageInput').focus();
            }, 100);
        });
    </script>
</body>
</html>